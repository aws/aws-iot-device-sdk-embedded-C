SHELL=/bin/bash

default: report

################################################################
# Define source location and cbmc binaries

# MQTT source directory relative to proof subdirectories.
MQTT ?= $(abspath ../../..)

GOTO_CC ?= goto-cc
GOTO_INSTRUMENT ?= goto-instrument
GOTO_ANALYZER ?= goto-analyzer
BATCH ?= cbmc-batch
VIEWER ?= cbmc-viewer


################################################################
# Build goto binary for cbmc
# Build goto binaries with options taken from top-level cmake

INC += \
	-I$(MQTT)/cbmc/proofs \
	-I$(MQTT)/demos \
	-I$(MQTT)/libraries/ \
	-I$(MQTT)/libraries/platform \
	-I$(MQTT)/libraries/standard/common/include \
	-I$(MQTT)/libraries/standard/mqtt/include \
	-I$(MQTT)/libraries/standard/mqtt/src \
	-I$(MQTT)/libraries/standard/mqtt/src/private \
	-I$(MQTT)/ports/common/include \

DEF += \
	-DIOT_SYSTEM_TYPES_FILE=\"$(MQTT)/ports/posix/include/iot_platform_types_posix.h\" \
	-Diotmqtt_EXPORTS \
	-DCBMC_OBJECT_BITS=$(CBMC_OBJECT_BITS) \
	-DCBMC_MAX_OBJECT_SIZE=$(CBMC_MAX_OBJECT_SIZE) \
	-DCBMC=1 \

CFLAGS += $(CFLAGS2) $(INC) $(DEF) -std=gnu99

%.goto : %.c
	$(GOTO_CC) -o $@ $(CFLAGS) $<

$(MQTT)/build:
	(mkdir -p $(MQTT)/build; cd $(MQTT)/build; cmake ..) \
	       > $(ENTRY)0.txt 2>&1

$(ENTRY)1.goto: $(MQTT)/build $(OBJS)
	$(GOTO_CC) --function harness -o $@ $(OBJS)
		> $(ENTRY)1.txt 2>&1

$(ENTRY)2.goto: $(ENTRY)1.goto
	 $(GOTO_INSTRUMENT) \
			$(ABSTRACTIONS) \
			--drop-unused-functions \
			--slice-global-inits $< $@ \
		> $(ENTRY)2.txt  2>&1

$(ENTRY).goto: $(ENTRY)2.goto
	cp $< $@


################################################################
# Set C compiler defines

CBMC_OBJECT_BITS ?= 8
CBMCFLAGS += --object-bits $(CBMC_OBJECT_BITS)
CBMC_MAX_OBJECT_SIZE = "(SIZE_MAX>>(CBMC_OBJECT_BITS+1))"


################################################################
# Run cbmc and build html report

CBMCFLAGS += \
	$(UNWINDING) \
	--bounds-check \
	--pointer-check \
	--unwinding-assertions \
	--nondet-static \
	--div-by-zero-check \
	--float-overflow-check \
	--nan-check \
	--pointer-overflow-check \
	--undefined-shift-check \
	--signed-overflow-check \
	--unsigned-overflow-check \
	--flush \

goto: $(ENTRY).goto

cbmc.txt: $(ENTRY).goto
	@echo cbmc $(CBMCFLAGS) --trace $< 2>&1 | tee $@
	cbmc $(CBMCFLAGS) --trace $< 2>&1 | tee -a $@

property.xml: $(ENTRY).goto
	cbmc $(CBMCFLAGS) --show-properties --xml-ui $< 2>&1 > $@

coverage.xml: $(ENTRY).goto
	cbmc $(filter-out --unwinding-assertions,$(CBMCFLAGS)) \
		--cover location --xml-ui $< 2>&1 > $@

cbmc: cbmc.txt

property: property.xml

coverage: coverage.xml

report: cbmc.txt property.xml coverage.xml
	$(VIEWER) \
	--goto $(ENTRY).goto \
	--srcdir $(MQTT) \
	--blddir $(MQTT) \
	--htmldir html \
	--srcexclude "(./verification|./tests|./tools|./lib/third_party)" \
	--result cbmc.txt \
	--property property.xml \
	--block coverage.xml

clean:
	$(RM) $(OBJS) $(ENTRY).goto
	$(RM) $(ENTRY)[0-9].goto $(ENTRY)[0-9].txt
	$(RM) cbmc.txt property.xml coverage.xml TAGS TAGS-*
	$(RM) *~ \#*

veryclean: clean
	$(RM) -r html

.PHONY: cbmc property coverage report clean veryclean

################################################################
# Run cbmc under cbmc-batch

BATCH ?= cbmc-batch
WS ?= ws
JOBOS ?= ubuntu16

define encode_options
       '=$(shell echo $(1) | sed 's/ ,/ /g' | sed 's/ /;/g')='
endef

PROPMEM ?= 64000
COVMEM ?= 64000
CBMCPKG ?= cbmc
BATCHPKG ?= cbmc-batch
VIEWERPKG ?= cbmc-viewer

SRC_ROOT ?= $(MQTT)
SRC_TARFILE ?= s3://cbmc/mqtt.tar.gz

BATCHFLAGS ?= \
	--srcdir $(MQTT) \
	--wsdir $(WS) \
	--jobprefix $(ENTRY) \
	--no-build \
	--goto $(ENTRY).goto \
	--cbmcflags $(call encode_options,$(CBMCFLAGS)) \
	--property-memory $(PROPMEM) \
	--coverage-memory $(COVMEM) \
	--cbmcpkg $(CBMCPKG) \
	--batchpkg $(BATCHPKG) \
	--viewerpkg $(VIEWERPKG) \
	--no-copysrc \
	--srctarfile $(SRC_TARFILE) \
	--blddir $(MQTT) \
	--jobos $(JOBOS) \

define yaml_encode_options
       "$(shell echo $(1) | sed 's/ ,/ /g' | sed 's/ /;/g')"
endef

$(ENTRY).yaml: $(ENTRY).goto Makefile
	echo 'jobos: $(JOBOS)' > $@
	echo 'cbmcpkg: $(CBMCPKG)' >> $@
	echo 'batchpkg: $(BATCHPKG)' >> $@
	echo 'viewerpkg: $(VIEWERPKG)' >> $@
	echo 'goto: $(ENTRY).goto' >> $@
	echo 'build: false' >> $@
	echo 'cbmcflags: $(call yaml_encode_options,$(CBMCFLAGS))' >> $@
	echo 'property_memory: $(PROPMEM)' >> $@
	echo 'coverage_memory: $(COVMEM)' >> $@
	echo 'expected: "SUCCESSFUL"' >> $@

launch: $(ENTRY).goto Makefile
	mkdir -p $(WS)
	cp $(ENTRY).goto $(WS)
	$(BATCH) $(BATCHFLAGS)

launch-clean:
	for d in $(ENTRY)*; do \
	  if [ -d $$d ]; then \
	    for f in $$d.json $$d.yaml Makefile-$$d; do \
	      if [ -f $$f ]; then mv $$f $$d; fi \
	    done\
	  fi \
	done
	$(RM) Makefile-$(ENTRY)-[0-9]*-[0-9]*
	$(RM) $(ENTRY)-[0-9]*-[0-9]*.json $(ENTRY)-[0-9]*-[0-9]*.yaml
	$(RM) -r $(WS)

launch-veryclean: launch-clean
	$(RM) -r $(ENTRY)-[0-9]*-[0-9]*

################################################################
# Build configuration file to run cbmc under cbmc-batch in CI

CBMC_FLAGS =  '$(call encode_options,$(CBMCFLAGS))'
cbmc-batch.yaml: Makefile ../Makefile.common
	@echo "Building $@"
	@$(RM) $@
	@echo 'cbmcflags: $(strip $(call yaml_encode_options,$(CBMCFLAGS)))' > $@
	@echo "expected: SUCCESSFUL" >> $@
	@echo "goto: $(ENTRY).goto" >> $@
	@echo "jobos: $(JOBOS)" >> $@

.PHONY: cbmc-batch.yaml

################################################################
