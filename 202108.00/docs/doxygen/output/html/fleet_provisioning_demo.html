<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AWS IoT Device SDK C: AWS IoT Fleet Provisioning Demo</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="foobar.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AWS IoT Device SDK C
   &#160;<span id="projectnumber">202108.00</span>
   </div>
   <div id="projectbrief">SDK for connecting to AWS IoT from a device using embedded C.</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('fleet_provisioning_demo.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">AWS IoT Fleet Provisioning Demo </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This demo demonstrates usage of the AWS IoT Fleet Provisioning library.</p>
<h1><a class="anchor" id="fleet_provisioning_demo_main"></a>
AWS IoT Fleet Provisioning Demo Overview</h1>
<p>The demo application showcases how a fleet of IoT devices can be provisioned with unique certificates and registered with AWS IoT Core using the Fleet Provisioning feature. This demo shows how devices with the ability to generate public-private key-pair on board can utilize a common claim certificate (across the entire fleet of devices) to request unique certificates from AWS IoT Core for their generated key-pairs, and register themselves with AWS IoT Core as AWS IoT Thing resources.</p>
<p>For more information on Fleet Provisioning feature of AWS IoT, refer to <a href="https://docs.aws.amazon.com/iot/latest/developerguide/provision-wo-cert.html">the AWS document</a>. There are 2 workflows of provisioning with Fleet Provisioning, <a href="https://docs.aws.amazon.com/iot/latest/developerguide/provision-wo-cert.html#claim-based"><b>Provisioning by Claim</b></a> and <a href="https://docs.aws.amazon.com/iot/latest/developerguide/provision-wo-cert.html#trusted-user"><b>Provisioning by Trusted User</b></a>. This demo shows use of the <b>Provisioning by Claim</b> workflow for provisioning devices with unique certificates using a common <b>Claim</b> certificate registered with AWS IoT Core.</p>
<p>This demo depends on the following libraries:</p><ul>
<li><a class="elRef" href="../../../../libraries/aws/fleet-provisioning-for-aws-iot-embedded-sdk/docs/doxygen/output/html/index.html#fleet_provisioning">Fleet Provisioning</a> for MQTT topic generation and matching.</li>
<li><a href="https://github.com/intel/tinycbor/tree/9924cfed3b95ad6de299ae675064430fdb886216">tinyCBOR</a> for CBOR encoding/decoding of MQTT payload to communicate with Fleet Provisioning APIs of AWS IoT Core.</li>
<li><a class="elRef" href="../../../../libraries/standard/coreMQTT/docs/doxygen/output/html/index.html#mqtt">coreMQTT</a> for performing MQTT client operations.</li>
<li><a href="https://github.com/ARMmbed/mbedtls/tree/e483a77c85e1f9c1dd2eb1c5a8f552d2617fe400">mbedTLS library</a> for TLS connection with AWS IoT Core.</li>
<li><a class="elRef" href="../../../../libraries/standard/corePKCS11/docs/doxygen/output/html/index.html#core_pkcs11">corePKCS11</a> for credential management and cryptographic operations.</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>The Fleet Provisioning library is agnostic to libraries used for network operations, credential management as well as payload serialization/de-serialization. You can replace any of the libraries with your library of choice.</dd></dl>
<h1><a class="anchor" id="fleet_provisioning_demo_setup"></a>
Instructions for setting up AWS resource before running the demo.</h1>
<p>For using the Fleet Provisioning feature of AWS IoT Core, you need to setup an <b>IAM role</b> and a <b>Provisioning Template</b> in your AWS account. These AWS resources can be setup either through the AWS console or programmatically through AWS CLI. Following are instructions with AWS CLI. (In the following example commands, replace the <code>&lt;aws-region&gt;</code>, <code>&lt;aws-account-id&gt;</code> with the AWS Region and ID relevant to your AWS account.)</p>
<ol type="1">
<li>Create an IAM role that will be needed by a fleet provisioning template. Replace <code>&lt;RoleName&gt;</code> with a name of the role you want to create. <div class="fragment"><div class="line">aws iam create-role \</div>
<div class="line">    --role-name &quot;&lt;RoleName&gt;&quot; \</div>
<div class="line">    --assume-role-policy-document &#39;{&quot;Version&quot;:&quot;2012-10-17&quot;,&quot;Statement&quot;:[{&quot;Action&quot;:&quot;sts:AssumeRole&quot;,&quot;Effect&quot;:&quot;Allow&quot;,&quot;Principal&quot;:{&quot;Service&quot;:&quot;iot.amazonaws.com&quot;}}]}&#39;</div>
</div><!-- fragment --></li>
<li>Attach a policy to the role created in the above step. Replace <code>&lt;RoleName&gt;</code> with the name of the role you created in Step 1. <div class="fragment"><div class="line">aws iam attach-role-policy \</div>
<div class="line">        --role-name &quot;&lt;RoleName&gt;&quot; \</div>
<div class="line">        --policy-arn arn:aws:iam::aws:policy/service-role/AWSIoTThingsRegistration</div>
</div><!-- fragment --></li>
<li>Create the template resource which will be used for provisioning the demo application. This needs to be done only once. For more information on fleet provisioning template, refer to <a href="https://docs.aws.amazon.com/iot/latest/developerguide/provision-template.html#fleet-provision-template">this guide</a> <div class="fragment"><div class="line">aws iot create-provisioning-template \</div>
<div class="line">        --template-name &lt;TemplateName&gt; \</div>
<div class="line">        --provisioning-role-arn arn:aws:iam::&lt;aws-account&gt;:service-role/&lt;RoleName&gt; \</div>
<div class="line">        --template-body file://template.json \</div>
<div class="line">        --enabled</div>
</div><!-- fragment --> In the above example, replace <code>&lt;TemplateName&gt;</code> with the name of the fleet provisioning template you want to create, <code>&lt;RoleName&gt;</code> with the name of the role you created in Step 1, and the <a href="file://template.json">file://template.json</a> with the file path to the template's JSON definition. Here is an example template for the demo (replace parts in angle brackets): <div class="fragment"><div class="line"> {</div>
<div class="line">   &quot;Parameters&quot;: {</div>
<div class="line">     &quot;SerialNumber&quot;: {</div>
<div class="line">       &quot;Type&quot;: &quot;String&quot;</div>
<div class="line">     },</div>
<div class="line">     &quot;AWS::IoT::Certificate::Id&quot;: {</div>
<div class="line">       &quot;Type&quot;: &quot;String&quot;</div>
<div class="line">     }</div>
<div class="line">   },</div>
<div class="line">   &quot;Resources&quot;: {</div>
<div class="line">     &quot;certificate&quot;: {</div>
<div class="line">       &quot;Properties&quot;: {</div>
<div class="line">         &quot;CertificateId&quot;: {</div>
<div class="line">           &quot;Ref&quot;: &quot;AWS::IoT::Certificate::Id&quot;</div>
<div class="line">         },</div>
<div class="line">         &quot;Status&quot;: &quot;Active&quot;</div>
<div class="line">       },</div>
<div class="line">       &quot;Type&quot;: &quot;AWS::IoT::Certificate&quot;</div>
<div class="line">     },</div>
<div class="line">     &quot;policy&quot;: {</div>
<div class="line">       &quot;Properties&quot;: {</div>
<div class="line">         &quot;PolicyName&quot;: &quot;&lt;provisioned-thing-policy&gt;&quot;</div>
<div class="line">       },</div>
<div class="line">       &quot;Type&quot;: &quot;AWS::IoT::Policy&quot;</div>
<div class="line">     },</div>
<div class="line">     &quot;thing&quot;: {</div>
<div class="line">       &quot;OverrideSettings&quot;: {</div>
<div class="line">         &quot;AttributePayload&quot;: &quot;MERGE&quot;,</div>
<div class="line">         &quot;ThingGroups&quot;: &quot;DO_NOTHING&quot;,</div>
<div class="line">         &quot;ThingTypeName&quot;: &quot;REPLACE&quot;</div>
<div class="line">       },</div>
<div class="line">       &quot;Properties&quot;: {</div>
<div class="line">         &quot;AttributePayload&quot;: {},</div>
<div class="line">         &quot;ThingGroups&quot;: [],</div>
<div class="line">         &quot;ThingName&quot;: {</div>
<div class="line">           &quot;Fn::Join&quot;: [</div>
<div class="line">             &quot;&quot;,</div>
<div class="line">             [</div>
<div class="line">               &quot;fp_demo_&quot;,</div>
<div class="line">               {</div>
<div class="line">                 &quot;Ref&quot;: &quot;SerialNumber&quot;</div>
<div class="line">               }</div>
<div class="line">             ]</div>
<div class="line">           ]</div>
<div class="line">         },</div>
<div class="line">         &quot;ThingTypeName&quot;: &quot;fp_demo_things&quot;</div>
<div class="line">       },</div>
<div class="line">       &quot;Type&quot;: &quot;AWS::IoT::Thing&quot;</div>
<div class="line">     }</div>
<div class="line">   },</div>
<div class="line">   &quot;DeviceConfiguration&quot;: {</div>
<div class="line">       &quot;Foo&quot;: &quot;Bar&quot;</div>
<div class="line">   }</div>
<div class="line"> }</div>
</div><!-- fragment -->.</li>
</ol>
<p>You can query the created template using the following CLI command. Replace the <code>&lt;TemplateName&gt;</code> with the name of the fleet provisioning template you created. </p><div class="fragment"><div class="line">aws iot describe-provisioning-template --template-name &lt;TemplateName&gt;</div>
</div><!-- fragment --><ol type="1">
<li>Create a claim certificate and private key to use for the Provisioning by Claim workflow in the demo. (Replace the angled brackets with credential file names of your choice.) <div class="fragment"><div class="line">aws iot create-keys-and-certificate \</div>
<div class="line">    --certificate-pem-outfile &quot;&lt;ClaimCertificate.pem&gt;&quot; \</div>
<div class="line">    --public-key-outfile &quot;&lt;ClaimPubKey.pem&gt;&quot; \</div>
<div class="line">    --private-key-outfile &quot;&lt;ClaimPrivateKey.pem&gt;&quot;</div>
</div><!-- fragment --></li>
<li>Create an IoT Policy for the Claim certificate. Following is an example of an IoT Policy. <div class="fragment"><div class="line"> {</div>
<div class="line">   &quot;Version&quot;: &quot;2012-10-17&quot;,</div>
<div class="line">   &quot;Statement&quot;: [</div>
<div class="line">     {</div>
<div class="line">       &quot;Effect&quot;: &quot;Allow&quot;,</div>
<div class="line">       &quot;Action&quot;: [</div>
<div class="line">         &quot;iot:Connect&quot;</div>
<div class="line">       ],</div>
<div class="line">       &quot;Resource&quot;: &quot;*&quot;</div>
<div class="line">     },</div>
<div class="line">     {</div>
<div class="line">       &quot;Effect&quot;: &quot;Allow&quot;,</div>
<div class="line">       &quot;Action&quot;: [</div>
<div class="line">         &quot;iot:Publish&quot;,</div>
<div class="line">         &quot;iot:Receive&quot;</div>
<div class="line">       ],</div>
<div class="line">       &quot;Resource&quot;: [</div>
<div class="line">         &quot;arn:aws:iot:&lt;aws-region&gt;:&lt;aws-account-id&gt;:topic/$aws/certificates/create-from-csr/*&quot;,</div>
<div class="line">         &quot;arn:aws:iot:&lt;aws-region&gt;:&lt;aws-account-id&gt;:topic/$aws/provisioning-templates/&lt;template-name&gt;/provision/*&quot;</div>
<div class="line">       ]</div>
<div class="line">     },</div>
<div class="line">     {</div>
<div class="line">       &quot;Effect&quot;: &quot;Allow&quot;,</div>
<div class="line">       &quot;Action&quot;: &quot;iot:Subscribe&quot;,</div>
<div class="line">       &quot;Resource&quot;: [</div>
<div class="line">         &quot;arn:aws:iot:&lt;aws-region&gt;:&lt;aws-account-id&gt;:topicfilter/$aws/certificates/create-from-csr/*&quot;,</div>
<div class="line">         &quot;arn:aws:iot:&lt;aws-region&gt;:&lt;aws-account-id&gt;:topicfilter/$aws/provisioning-templates/&lt;template-name&gt;/provision/*&quot;</div>
<div class="line">       ]</div>
<div class="line">     }</div>
<div class="line">   ]</div>
<div class="line"> }</div>
</div><!-- fragment -->.</li>
</ol>
<p>Following is the AWS CLI command for creating an IoT Policy. Replace <code>&lt;PolicyName&gt;</code> with the name of the IoT Policy you want to create, and <a href="file://policy.json">file://policy.json</a> with the path to the JSON definition file for the Policy in your system. </p><div class="fragment"><div class="line">aws iot create-policy \</div>
<div class="line">    --policy-name &lt;PolicyName&gt; \</div>
<div class="line">    --policy-document file://policy.json</div>
</div><!-- fragment --><ol type="1">
<li>Attach the policy to the claim certificate. Replace <code>&lt;Claim-Cert-ID&gt;</code> with the certificate ID of the Claim Certificate that you created in Step 4. <div class="fragment"><div class="line">aws iot attach-policy \</div>
<div class="line">    --target &quot;arn:aws:iot:&lt;aws-region&gt;:&lt;aws-account-id&gt;:cert/&lt;Claim-Cert-ID&gt;&quot; \</div>
<div class="line">    --policy-name &quot;&lt;PolicyName&gt;&quot;</div>
</div><!-- fragment --></li>
</ol>
<h1><a class="anchor" id="Demo"></a>
Workflow</h1>
<p>As mentioned before, the demo showcases the <b>Provisioning by Claim</b> workflow of the Fleet Provisioning feature of AWS IoT Core. It uses the Claim Credentials to establish an MQTT connection with AWS IoT Core and calls the <a href="https://docs.aws.amazon.com/iot/latest/developerguide/fleet-provision-api.html#create-cert-csr"><b>CreateCertificateWithCsr</b> MQTT API</a> to request a certificate for the Certificate Signing Request of the key-pair generated by the demo, and the <a href="https://docs.aws.amazon.com/iot/latest/developerguide/fleet-provision-api.html#register-thing"><b>RegisterThing</b> MQTT API</a> to create an AWS IoT Thing for the demo with the provisioned certificate. After getting provisioned with a new certificate, the demo creates a new MQTT connection with AWS IoT Core with the new provisioned credentials.</p>
<p>The below diagram is an overview of the operations performed by the demo.</p>
<div class="image">
<img src="fleet_provisioning_demo.png" alt="" width="50%"/>
</div>
 </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
